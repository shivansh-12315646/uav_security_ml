{% extends "base.html" %}

{% block title %}Dataset Analyzer - UAV Security ML{% endblock %}

{% block extra_css %}
<style>
    .analyzer-container {
        padding: 2rem 0;
    }
    
    .analyzer-card {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .upload-zone {
        border: 2px dashed rgba(59, 130, 246, 0.5);
        border-radius: 0.75rem;
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(59, 130, 246, 0.05);
    }
    
    .upload-zone:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
    }
    
    .upload-zone.drag-over {
        border-color: #8b5cf6;
        background: rgba(139, 92, 246, 0.1);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #3b82f6;
    }
    
    .stat-label {
        color: #94a3b8;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 0.5rem;
    }
    
    .feature-table {
        background: rgba(15, 23, 42, 0.6);
        border-radius: 0.75rem;
        overflow: hidden;
    }
    
    .feature-table table {
        width: 100%;
        color: #cbd5e1;
    }
    
    .feature-table th {
        background: rgba(59, 130, 246, 0.1);
        padding: 1rem;
        text-align: left;
        color: #3b82f6;
        font-weight: 600;
        border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    .feature-table td {
        padding: 1rem;
        border-bottom: 1px solid rgba(59, 130, 246, 0.1);
    }
    
    .chart-container {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 0.75rem;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .quality-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .quality-excellent {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .quality-good {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }
    
    .quality-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .quality-poor {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container analyzer-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4" data-aos="fade-down">
        <div>
            <h1 class="training-title">üîç Dataset Analyzer</h1>
            <p class="text-muted">Analyze your dataset quality and statistics before training</p>
        </div>
        <div>
            <a href="{{ url_for('training.dashboard') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Training
            </a>
        </div>
    </div>
    
    <!-- Upload Section -->
    <div class="analyzer-card" data-aos="fade-up">
        <h3 class="mb-4">
            <i class="fas fa-upload"></i> Upload Dataset for Analysis
        </h3>
        
        <div class="upload-zone" id="uploadZone">
            <i class="fas fa-file-csv fa-3x mb-3" style="color: #3b82f6;"></i>
            <h5>Upload CSV Dataset</h5>
            <p class="text-muted">Drag & drop your CSV file here or click to browse</p>
            <input type="file" id="datasetFile" accept=".csv" class="d-none">
        </div>
    </div>
    
    <!-- Analysis Results -->
    <div id="analysisResults" class="d-none">
        <!-- Dataset Overview -->
        <div class="analyzer-card" data-aos="fade-up">
            <h3 class="mb-4">
                <i class="fas fa-info-circle"></i> Dataset Overview
            </h3>
            
            <div class="stats-grid" id="overviewStats">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        
        <!-- Data Quality Assessment -->
        <div class="analyzer-card" data-aos="fade-up">
            <h3 class="mb-4">
                <i class="fas fa-check-circle"></i> Data Quality Assessment
            </h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="classDistributionChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="nullValuesChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="qualityAssessment" class="mt-4">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        
        <!-- Feature Statistics -->
        <div class="analyzer-card" data-aos="fade-up">
            <h3 class="mb-4">
                <i class="fas fa-chart-bar"></i> Feature Statistics
            </h3>
            
            <div class="feature-table">
                <table id="featureStatsTable">
                    <!-- Will be populated dynamically -->
                </table>
            </div>
        </div>
        
        <!-- Feature Distributions -->
        <div class="analyzer-card" data-aos="fade-up">
            <h3 class="mb-4">
                <i class="fas fa-chart-line"></i> Feature Distributions
            </h3>
            
            <div class="row" id="distributionCharts">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        
        <!-- Recommendations -->
        <div class="analyzer-card" data-aos="fade-up">
            <h3 class="mb-4">
                <i class="fas fa-lightbulb"></i> Recommendations
            </h3>
            
            <div id="recommendations">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

<script>
    // File upload handling
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('datasetFile');
    
    uploadZone.addEventListener('click', () => fileInput.click());
    
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });
    
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('drag-over');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            analyzeFile(files[0]);
        }
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            analyzeFile(e.target.files[0]);
        }
    });
    
    function analyzeFile(file) {
        if (!file.name.endsWith('.csv')) {
            Toastify({
                text: 'Please upload a CSV file',
                backgroundColor: '#ef4444',
                duration: 3000
            }).showToast();
            return;
        }
        
        const formData = new FormData();
        formData.append('dataset', file);
        
        Toastify({
            text: 'Analyzing dataset...',
            backgroundColor: '#3b82f6',
            duration: 2000
        }).showToast();
        
        fetch('/training/analyze-dataset', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAnalysis(data);
                
                Toastify({
                    text: 'Analysis completed!',
                    backgroundColor: '#10b981',
                    duration: 3000
                }).showToast();
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            Toastify({
                text: 'Error: ' + error.message,
                backgroundColor: '#ef4444',
                duration: 3000
            }).showToast();
        });
    }
    
    function displayAnalysis(data) {
        document.getElementById('analysisResults').classList.remove('d-none');
        
        // Display overview stats
        displayOverviewStats(data);
        
        // Create visualizations
        createClassDistributionChart(data);
        createNullValuesChart(data);
        
        // Display feature statistics
        displayFeatureStats(data);
        
        // Display quality assessment
        displayQualityAssessment(data);
        
        // Display recommendations
        displayRecommendations(data);
        
        // Scroll to results
        document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
    }
    
    function displayOverviewStats(data) {
        const container = document.getElementById('overviewStats');
        
        const balance = (data.normal_samples / data.total_samples * 100).toFixed(1);
        const imbalanceRatio = (data.attack_samples / data.normal_samples).toFixed(2);
        
        container.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${data.total_samples.toLocaleString()}</div>
                <div class="stat-label">Total Samples</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.features}</div>
                <div class="stat-label">Features</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.normal_samples.toLocaleString()}</div>
                <div class="stat-label">Normal Samples</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.attack_samples.toLocaleString()}</div>
                <div class="stat-label">Attack Samples</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${balance}%</div>
                <div class="stat-label">Normal Ratio</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">1:${imbalanceRatio}</div>
                <div class="stat-label">Class Ratio</div>
            </div>
        `;
    }
    
    function createClassDistributionChart(data) {
        const ctx = document.getElementById('classDistributionChart');
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Normal', 'Attack'],
                datasets: [{
                    data: [data.normal_samples, data.attack_samples],
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(239, 68, 68, 0.7)'
                    ],
                    borderColor: [
                        'rgba(16, 185, 129, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Class Distribution',
                        color: '#cbd5e1',
                        font: { size: 16 }
                    },
                    legend: {
                        labels: { color: '#cbd5e1' }
                    }
                }
            }
        });
    }
    
    function createNullValuesChart(data) {
        const ctx = document.getElementById('nullValuesChart');
        
        const features = Object.keys(data.null_values);
        const nullCounts = Object.values(data.null_values);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: features,
                datasets: [{
                    label: 'Missing Values',
                    data: nullCounts,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Missing Values by Feature',
                        color: '#cbd5e1',
                        font: { size: 16 }
                    },
                    legend: {
                        labels: { color: '#cbd5e1' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#cbd5e1' },
                        grid: { color: 'rgba(59, 130, 246, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#cbd5e1' },
                        grid: { color: 'rgba(59, 130, 246, 0.1)' }
                    }
                }
            }
        });
    }
    
    function displayFeatureStats(data) {
        const table = document.getElementById('featureStatsTable');
        
        let html = `
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Mean</th>
                    <th>Std Dev</th>
                    <th>Min</th>
                    <th>Max</th>
                    <th>25%</th>
                    <th>50%</th>
                    <th>75%</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        const features = ['packet_size', 'inter_arrival_time', 'packet_rate', 'connection_duration', 'failed_logins'];
        
        features.forEach(feature => {
            if (data.feature_stats[feature]) {
                const stats = data.feature_stats[feature];
                html += `
                    <tr>
                        <td><strong>${feature}</strong></td>
                        <td>${stats.mean?.toFixed(2) || 'N/A'}</td>
                        <td>${stats.std?.toFixed(2) || 'N/A'}</td>
                        <td>${stats.min?.toFixed(2) || 'N/A'}</td>
                        <td>${stats.max?.toFixed(2) || 'N/A'}</td>
                        <td>${stats['25%']?.toFixed(2) || 'N/A'}</td>
                        <td>${stats['50%']?.toFixed(2) || 'N/A'}</td>
                        <td>${stats['75%']?.toFixed(2) || 'N/A'}</td>
                    </tr>
                `;
            }
        });
        
        html += '</tbody>';
        table.innerHTML = html;
    }
    
    function displayQualityAssessment(data) {
        const container = document.getElementById('qualityAssessment');
        
        // Calculate quality score
        const totalNulls = Object.values(data.null_values).reduce((a, b) => a + b, 0);
        const nullPercentage = (totalNulls / (data.total_samples * data.features)) * 100;
        
        const balance = Math.abs(50 - (data.normal_samples / data.total_samples * 100));
        
        let qualityClass = 'quality-excellent';
        let qualityText = 'Excellent';
        
        if (nullPercentage > 10 || balance > 30) {
            qualityClass = 'quality-poor';
            qualityText = 'Needs Improvement';
        } else if (nullPercentage > 5 || balance > 20) {
            qualityClass = 'quality-warning';
            qualityText = 'Fair';
        } else if (nullPercentage > 1 || balance > 10) {
            qualityClass = 'quality-good';
            qualityText = 'Good';
        }
        
        container.innerHTML = `
            <div class="text-center">
                <h4>Overall Data Quality: <span class="quality-badge ${qualityClass}">${qualityText}</span></h4>
                <p class="text-muted mt-3">
                    Missing values: ${nullPercentage.toFixed(2)}% | 
                    Class imbalance: ${balance.toFixed(1)}% deviation from perfect balance
                </p>
            </div>
        `;
    }
    
    function displayRecommendations(data) {
        const container = document.getElementById('recommendations');
        
        const recommendations = [];
        
        // Check for missing values
        const totalNulls = Object.values(data.null_values).reduce((a, b) => a + b, 0);
        if (totalNulls > 0) {
            recommendations.push({
                type: 'warning',
                icon: 'fa-exclamation-triangle',
                title: 'Missing Values Detected',
                text: `Found ${totalNulls} missing values. Consider imputation or removal before training.`
            });
        }
        
        // Check class balance
        const balance = (data.normal_samples / data.total_samples * 100);
        if (balance < 40 || balance > 60) {
            recommendations.push({
                type: 'warning',
                icon: 'fa-balance-scale',
                title: 'Class Imbalance',
                text: `Dataset has ${balance.toFixed(1)}% normal samples. Consider using SMOTE or class weights.`
            });
        }
        
        // Check sample size
        if (data.total_samples < 1000) {
            recommendations.push({
                type: 'info',
                icon: 'fa-database',
                title: 'Small Dataset',
                text: 'Consider collecting more data for better model generalization.'
            });
        } else {
            recommendations.push({
                type: 'success',
                icon: 'fa-check-circle',
                title: 'Sufficient Data',
                text: `${data.total_samples} samples is adequate for training.`
            });
        }
        
        // General recommendation
        recommendations.push({
            type: 'info',
            icon: 'fa-lightbulb',
            title: 'Feature Engineering',
            text: 'Consider creating additional features or normalizing existing ones for better performance.'
        });
        
        let html = '<div class="row">';
        recommendations.forEach(rec => {
            const color = {
                'success': '#10b981',
                'warning': '#f59e0b',
                'info': '#3b82f6',
                'error': '#ef4444'
            }[rec.type];
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="p-3" style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid ${color}; border-radius: 0.5rem;">
                        <div class="d-flex">
                            <i class="fas ${rec.icon} fa-2x me-3" style="color: ${color};"></i>
                            <div>
                                <strong style="color: ${color};">${rec.title}</strong>
                                <p class="text-muted mb-0 mt-2">${rec.text}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }
</script>
{% endblock %}
