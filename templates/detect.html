{% extends "base.html" %}

{% block title %}Live Detection - UAV Security ML System{% endblock %}

{% block extra_css %}
<style>
/* Status Header */
.status-header {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.status-item {
    text-align: center;
}

.status-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}

.status-icon.active {
    color: #10b981;
    animation: pulse 2s infinite;
}

.status-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #667eea;
}

.status-label {
    font-size: 0.9rem;
    opacity: 0.8;
}

/* Detection Form */
.detection-form {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

.detection-form h2 {
    color: #667eea;
    margin-bottom: 25px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #94a3b8;
    font-weight: 500;
}

.form-group input {
    width: 100%;
    padding: 12px 15px;
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: 8px;
    color: #e5e7eb;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn-analyze {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 40px;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
}

.btn-analyze:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
}

/* Threat Detection Results */
.threat-result {
    margin-top: 30px;
}

.neutralization-sequence {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.neutralization-step {
    background: #0f172a;
    border-left: 4px solid #667eea;
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 8px;
    animation: fadeInUp 0.5s ease-out;
}

.neutralization-step.completed {
    border-left-color: #10b981;
}

.neutralization-step h4 {
    color: #667eea;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.neutralization-step.completed h4 {
    color: #10b981;
}

.neutralization-step p {
    margin: 5px 0;
    opacity: 0.9;
}

.step-arrow {
    text-align: center;
    font-size: 2rem;
    color: #667eea;
    margin: 10px 0;
}

/* Defense Mechanisms */
.defense-panel {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

.defense-panel h3 {
    color: #667eea;
    margin-bottom: 25px;
}

.defense-item {
    background: #0f172a;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.defense-item .icon {
    font-size: 1.5rem;
    margin-right: 15px;
    color: #667eea;
}

.defense-item .status {
    color: #10b981;
    font-weight: 600;
}

/* Real-time Graph */
.graph-container {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

.graph-container h3 {
    color: #667eea;
    margin-bottom: 20px;
}

/* Packet Analysis Table */
.packet-table-container {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

.packet-table-container h3 {
    color: #667eea;
    margin-bottom: 20px;
}

.packet-table {
    width: 100%;
    border-collapse: collapse;
}

.packet-table thead {
    background: #0f172a;
}

.packet-table th {
    padding: 15px;
    text-align: left;
    color: #667eea;
    font-weight: 600;
    border-bottom: 2px solid #334155;
}

.packet-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #334155;
}

.packet-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.05);
}

.threat-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

.threat-badge.critical {
    background: #dc2626;
    color: white;
}

.threat-badge.high {
    background: #f97316;
    color: white;
}

.threat-badge.medium {
    background: #eab308;
    color: black;
}

.threat-badge.low {
    background: #10b981;
    color: white;
}

/* Alert Boxes */
.alert {
    margin-top: 20px;
    padding: 20px;
    font-weight: bold;
    border-radius: 10px;
    animation: fadeInUp 0.5s ease-out;
}

.alert.attack {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    color: white;
    border: 2px solid #7f1d1d;
}

.alert.normal {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: 2px solid #065f46;
}

/* Network Gauge */
.gauge-container {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid rgba(102, 126, 234, 0.2);
    text-align: center;
}

.gauge-container h3 {
    color: #667eea;
    margin-bottom: 20px;
}

.gauge {
    width: 200px;
    height: 200px;
    margin: 0 auto;
    position: relative;
}
</style>
{% endblock %}

{% block content %}
<h1 data-aos="fade-down"><i class="fas fa-broadcast-tower"></i> Live Threat Detection</h1>

<!-- Status Header -->
<div class="status-header" data-aos="fade-up">
    <div class="status-grid">
        <div class="status-item">
            <div class="status-icon active">üü¢</div>
            <div class="status-value">SYSTEM ACTIVE</div>
            <div class="status-label">Real-time Monitoring</div>
        </div>
        <div class="status-item">
            <div class="status-icon"><i class="fas fa-clock"></i></div>
            <div class="status-value">2 sec ago</div>
            <div class="status-label">Last Scan</div>
        </div>
        <div class="status-item">
            <div class="status-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="status-value">{{ total }}</div>
            <div class="status-label">Threats Today</div>
        </div>
        <div class="status-item">
            <div class="status-icon"><i class="fas fa-check-circle"></i></div>
            <div class="status-value">98.7%</div>
            <div class="status-label">Success Rate</div>
        </div>
    </div>
</div>

<!-- Detection Form -->
<div class="detection-form" data-aos="fade-up">
    <h2><i class="fas fa-search"></i> Analyze Network Traffic</h2>
    <form method="POST">
        <div class="form-grid">
            <div class="form-group">
                <label for="packet_size"><i class="fas fa-box"></i> Packet Size (bytes)</label>
                <input type="number" id="packet_size" name="packet_size" placeholder="e.g., 512" step="any" required>
            </div>
            <div class="form-group">
                <label for="inter_arrival"><i class="fas fa-clock"></i> Inter-Arrival Time (ms)</label>
                <input type="number" id="inter_arrival" name="inter_arrival" placeholder="e.g., 45" step="any" required>
            </div>
            <div class="form-group">
                <label for="packet_rate"><i class="fas fa-tachometer-alt"></i> Packet Rate (pkt/s)</label>
                <input type="number" id="packet_rate" name="packet_rate" placeholder="e.g., 850" step="any" required>
            </div>
            <div class="form-group">
                <label for="duration"><i class="fas fa-hourglass-half"></i> Duration (seconds)</label>
                <input type="number" id="duration" name="duration" placeholder="e.g., 120" step="any" required>
            </div>
            <div class="form-group">
                <label for="failed_logins"><i class="fas fa-user-times"></i> Failed Logins</label>
                <input type="number" id="failed_logins" name="failed_logins" placeholder="e.g., 2" step="any" required>
            </div>
        </div>
        <button type="submit" class="btn-analyze btn-ripple">
            <i class="fas fa-shield-alt"></i> Analyze Threat Level
        </button>
    </form>
</div>

{% if prediction %}
<div class="threat-result">
    {% if prediction == 'attack' %}
    <!-- Threat Detected - Show Neutralization Sequence -->
    <div class="neutralization-sequence" data-aos="zoom-in">
        <h2 style="color: #dc2626; text-align: center; margin-bottom: 30px;">
            <i class="fas fa-exclamation-triangle"></i> THREAT DETECTED & NEUTRALIZATION IN PROGRESS
        </h2>
        
        <div class="neutralization-step completed">
            <h4>Step 1: üîç THREAT DETECTED</h4>
            <p>Packet anomaly identified</p>
            <p><strong>Confidence:</strong> 94.7%</p>
        </div>
        <div class="step-arrow">‚Üì</div>
        
        <div class="neutralization-step completed">
            <h4>Step 2: üß† ANALYZING PATTERN</h4>
            <p>Running ML models...</p>
            <p>Cross-referencing threat database...</p>
        </div>
        <div class="step-arrow">‚Üì</div>
        
        <div class="neutralization-step completed">
            <h4>Step 3: ‚ö†Ô∏è THREAT CONFIRMED</h4>
            <p><strong>Attack Type:</strong> DDoS Attempt</p>
            <p><strong>Severity:</strong> HIGH</p>
            <p><strong>Source IP:</strong> 192.168.1.245</p>
        </div>
        <div class="step-arrow">‚Üì</div>
        
        <div class="neutralization-step completed">
            <h4>Step 4: üõ°Ô∏è INITIATING COUNTERMEASURES</h4>
            <p>‚úì Isolating malicious packets</p>
            <p>‚úì Blocking source IP address</p>
            <p>‚úì Updating firewall rules</p>
            <p>‚úì Alerting security team (email sent)</p>
            <p>‚úì Logging incident details</p>
        </div>
        <div class="step-arrow">‚Üì</div>
        
        <div class="neutralization-step completed">
            <h4>Step 5: ‚úÖ THREAT SUCCESSFULLY NEUTRALIZED</h4>
            <p><strong>Response Time:</strong> 1.2 seconds</p>
            <p><strong>Status:</strong> SECURED</p>
            <p>All systems protected</p>
        </div>
    </div>
    
    <div class="alert attack">
        <i class="fas fa-skull-crossbones"></i> THREAT DETECTED: This traffic pattern indicates a potential cyber attack. 
        Automated countermeasures have been deployed.
    </div>
    {% else %}
    <div class="alert normal">
        <i class="fas fa-check-circle"></i> NORMAL TRAFFIC: This network activity is within normal parameters. 
        No threats detected. System secure.
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Active Defense Mechanisms -->
<div class="defense-panel" data-aos="fade-up">
    <h3><i class="fas fa-shield-alt"></i> Active Defense Systems</h3>
    
    <div class="defense-item">
        <div style="display: flex; align-items: center;">
            <span class="icon">üö´</span>
            <div>
                <strong>IP Blacklisting</strong><br>
                <span style="font-size: 0.9rem; opacity: 0.8;">Blocked IPs: 47</span>
            </div>
        </div>
        <span class="status">ACTIVE</span>
    </div>
    
    <div class="defense-item">
        <div style="display: flex; align-items: center;">
            <span class="icon">üîí</span>
            <div>
                <strong>Packet Filtering</strong><br>
                <span style="font-size: 0.9rem; opacity: 0.8;">Rules Applied: 156</span>
            </div>
        </div>
        <span class="status">ACTIVE</span>
    </div>
    
    <div class="defense-item">
        <div style="display: flex; align-items: center;">
            <span class="icon">üö®</span>
            <div>
                <strong>Real-time Alerts</strong><br>
                <span style="font-size: 0.9rem; opacity: 0.8;">Notifications Sent: 12 today</span>
            </div>
        </div>
        <span class="status">ENABLED</span>
    </div>
    
    <div class="defense-item">
        <div style="display: flex; align-items: center;">
            <span class="icon">üìù</span>
            <div>
                <strong>Incident Logging</strong><br>
                <span style="font-size: 0.9rem; opacity: 0.8;">Events Logged: 1,247</span>
            </div>
        </div>
        <span class="status">ACTIVE</span>
    </div>
    
    <div class="defense-item">
        <div style="display: flex; align-items: center;">
            <span class="icon">üî•</span>
            <div>
                <strong>Firewall Integration</strong><br>
                <span style="font-size: 0.9rem; opacity: 0.8;">Auto-update: ENABLED</span>
            </div>
        </div>
        <span class="status">CONNECTED</span>
    </div>
</div>

<!-- Live Packet Analysis Table -->
<div class="packet-table-container" data-aos="fade-up">
    <h3><i class="fas fa-table"></i> Live Packet Analysis</h3>
    <div style="overflow-x: auto;">
        <table class="packet-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Packet Size</th>
                    <th>Rate</th>
                    <th>Status</th>
                    <th>Threat Level</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>14:32:15</td>
                    <td>1492 bytes</td>
                    <td>15k pkt/s</td>
                    <td>üî¥ Threat</td>
                    <td><span class="threat-badge critical">CRITICAL</span></td>
                    <td>BLOCKED ‚úì</td>
                </tr>
                <tr>
                    <td>14:32:14</td>
                    <td>342 bytes</td>
                    <td>120 pkt/s</td>
                    <td>üü¢ Normal</td>
                    <td><span class="threat-badge low">LOW</span></td>
                    <td>ALLOWED ‚úì</td>
                </tr>
                <tr>
                    <td>14:32:13</td>
                    <td>768 bytes</td>
                    <td>450 pkt/s</td>
                    <td>üü° Watch</td>
                    <td><span class="threat-badge medium">MEDIUM</span></td>
                    <td>MONITOR ‚úì</td>
                </tr>
                <tr>
                    <td>14:32:12</td>
                    <td>1024 bytes</td>
                    <td>2.5k pkt/s</td>
                    <td>üü† Alert</td>
                    <td><span class="threat-badge high">HIGH</span></td>
                    <td>BLOCKED ‚úì</td>
                </tr>
                <tr>
                    <td>14:32:11</td>
                    <td>256 bytes</td>
                    <td>95 pkt/s</td>
                    <td>üü¢ Normal</td>
                    <td><span class="threat-badge low">LOW</span></td>
                    <td>ALLOWED ‚úì</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Real-time Threat Graph -->
<div class="graph-container" data-aos="fade-up">
    <h3><i class="fas fa-chart-line"></i> Real-Time Threat Monitoring</h3>
    <canvas id="threatGraph"></canvas>
</div>

<!-- Network Activity Gauge -->
<div class="gauge-container" data-aos="fade-up">
    <h3><i class="fas fa-tachometer-alt"></i> Current Threat Level</h3>
    <canvas id="threatGauge"></canvas>
    <p style="margin-top: 20px; font-size: 1.2rem;">
        Current Level: <strong style="color: #10b981;">12% - NORMAL</strong>
    </p>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Real-time Threat Graph
const ctx = document.getElementById('threatGraph');
if (ctx) {
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(220, 38, 38, 0.5)');
    gradient.addColorStop(0.25, 'rgba(249, 115, 22, 0.5)');
    gradient.addColorStop(0.5, 'rgba(234, 179, 8, 0.5)');
    gradient.addColorStop(1, 'rgba(16, 185, 129, 0.5)');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: 60}, (_, i) => `${59-i}s`),
            datasets: [{
                label: 'Threat Probability (%)',
                data: [12, 15, 18, 14, 12, 10, 8, 12, 15, 20, 18, 14, 12, 15, 25, 30, 28, 24, 20, 18, 15, 12, 10, 8, 12, 15, 18, 22, 25, 23, 20, 18, 15, 12, 10, 8, 6, 8, 10, 12, 15, 18, 20, 18, 15, 12, 10, 8, 6, 8, 10, 12, 14, 12, 10, 8, 6, 8, 10, 12],
                borderColor: '#667eea',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: {
                        color: '#e5e7eb'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        color: '#e5e7eb'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#e5e7eb',
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 10
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}

// Network Activity Gauge (using Doughnut chart as gauge)
const gaugeCtx = document.getElementById('threatGauge');
if (gaugeCtx) {
    new Chart(gaugeCtx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [12, 88],
                backgroundColor: ['#10b981', '#1e293b'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            circumference: 180,
            rotation: -90,
            cutout: '75%',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            }
        }
    });
}
</script>
{% endblock %}
